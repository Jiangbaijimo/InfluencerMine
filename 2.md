

### **达人数据爬取与管理系统设计方案**

#### 1. 系统概述

本方案旨在设计一个高效、可扩展的达人数据爬取与管理系统。核心目标是解决 **任务调度** 和 **多账号管理** 两大难题，实现数据的持续、稳定入库与导出，并提供详尽的日志记录与断点续爬功能，确保数据处理流程的完整性与可追溯性。

#### 2. 系统架构设计

系统将采用模块化设计，主要由以下几个核心组件构成，以实现入库和导出的完全解耦，支持真正的并行处理。**核心特点是入库与导出分别运行在独立的线程中，实现完全异步的数据处理流程。**

*   **接入层 (API/CLI)**: 用户通过命令行界面（CLI）或API与系统交互，下发任务指令（如：开始爬取某个领域的达人）。
*   **任务调度中心 (Task Scheduler)**: 系统的"大脑"，负责接收任务、拆分任务、将任务分配给账号，并跟踪任务状态。支持同时调度入库和导出两类任务。
*   **多账号管理器 (Account Manager)**: 统一管理所有可用账号，包括账号状态（空闲、工作中、禁用）、每日导出配额等。支持账号在入库和导出线程间的动态分配。
*   **入库服务线程 (Ingestion Service Thread)**: **独立的线程进程**，专门负责执行数据爬取和入库操作。它从任务调度中心获取入库任务，使用指定账号爬取数据，并将原始数据持续存入数据库。该线程可以7×24小时不间断运行，不受导出限制影响。
*   **导出服务线程 (Export Service Thread)**: **独立的线程进程**，专门负责执行数据导出操作。它根据任务调度中心的指令，从数据库中提取已入库的数据，并生成指定格式的文件（如CSV），同时严格遵守账号的导出配额限制。该线程与入库线程完全独立运行。
*   **数据存储 (Database)**: 使用MySQL数据库，存储达人信息、账号信息、任务状态、以及各类日志。通过数据库作为入库和导出线程间的数据交换媒介。
*   **日志系统 (Logging System)**: 记录所有关键操作，包括任务创建、数据入库、数据导出等，方便追踪和审计。支持分别记录入库和导出线程的操作日志。

**架构图:**
```
[ 用户 (CLI/API) ]
       |
       v
[ 任务调度中心 ] <---> [ 多账号管理器 ]
   |         |
   |         |
   v         v
[入库服务线程] [导出服务线程]  ← 独立线程，并行运行
   |         |
   |         |
   v         v
[     数据存储 (MySQL)     ] <---> [ 日志系统 ]

线程特性说明：
• 入库服务线程：持续爬取数据并入库，不受导出限制影响
• 导出服务线程：从数据库读取数据并导出，受账号配额限制
• 两个线程通过数据库进行数据交换，实现完全解耦
• 支持同时运行多个入库和导出线程实例
```

#### 3. 数据库模型设计 (Data Models)

为了支撑整个系统，我们设计了以下几张核心数据表：

##### 3.1. `influencers` (达人信息表)
存储达人的基础信息。

| 字段名 | 类型 | 描述 | 备注 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | 唯一ID | 主键, 自增 |
| `nickname` | `VARCHAR(255)` | 达人昵称 | |
| `uid` | `VARCHAR(255)` | 达人唯一标识 | 用于去重 |
| `domain` | `VARCHAR(100)` | 所属领域 | 如：美妆、游戏 |
| `source_page` | `VARCHAR(255)` | 来源页面/URL | |
| `raw_data` | `JSON` | 爬取的原始数据 | |
| `status` | `ENUM('pending_export', 'exported')` | 导出状态 | 默认为 `pending_export` |
| `ingested_at` | `DATETIME` | 入库时间 | |
| `ingestion_log_id` | `BIGINT` | 关联的入库日志ID | 外键 |

##### 3.2. `accounts` (账号信息表)
管理所有爬虫账号。

| 字段名 | 类型 | 描述 | 备注 |
| :--- | :--- | :--- | :--- |
| `id` | `INT` | 账号ID | 主键, 自增 |
| `username` | `VARCHAR(255)` | 账号名 | |
| `password` | `VARCHAR(255)` | 账号密码（加密存储） | |
| `status` | `ENUM('idle', 'ingesting', 'exporting', 'disabled')` | 账号当前状态 | |
| `daily_export_limit` | `INT` | 每日导出上限 | 例如：4000 |
| `today_export_count` | `INT` | 今日已导出数量 | 每日凌晨定时重置 |
| `last_used_at` | `DATETIME` | 最后使用时间 | |

##### 3.3. `tasks` (任务表)
用于任务的创建和追踪，实现断点续爬的关键。

| 字段名 | 类型 | 描述 | 备注 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | 任务ID | 主键, 自增 |
| `task_type` | `ENUM('ingestion', 'export')` | 任务类型 | |
| `domain` | `VARCHAR(100)` | 目标领域 | |
| `status` | `ENUM('pending', 'in_progress', 'paused', 'completed', 'failed')` | 任务状态 | |
| `progress_marker` | `VARCHAR(255)` | 进度标记 | 如：页码 `page=10` |
| `assigned_account_id` | `INT` | 当前执行任务的账号ID | 外键 |
| `created_at` | `DATETIME` | 创建时间 | |
| `updated_at` | `DATETIME` | 最后更新时间 | |

##### 3.4. `ingestion_logs` (入库日志表)
**功能实现**: 记录了“什么类型的达人今天哪个账号入库了多少个，入库时间，达人昵称，页码，领域等”。

| 字段名 | 类型 | 描述 | 备注 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | 日志ID | 主键, 自增 |
| `task_id` | `BIGINT` | 关联的任务ID | 外键 |
| `account_id` | `INT` | 使用的账号ID | 外键 |
| `domain` | `VARCHAR(100)` | 爬取领域 | |
| `page_number` | `INT` | 爬取页码 | |
| `ingested_count` | `INT` | 本次入库数量 | |
| `start_time` | `DATETIME` | 开始时间 | |
| `end_time` | `DATETIME` | 结束时间 | |

##### 3.5. `export_logs` (导出日志表)
**功能实现**: 记录了“账号一导出了4000个什么类型的达人”。

| 字段名 | 类型 | 描述 | 备注 |
| :--- | :--- | :--- | :--- |
| `id` | `BIGINT` | 日志ID | 主键, 自增 |
| `task_id` | `BIGINT` | 关联的任务ID | 外键 |
| `account_id` | `INT` | 使用的账号ID | 外键 |
| `domain` | `VARCHAR(100)` | 导出领域 | |
| `exported_count` | `INT` | 本次导出数量 | |
| `file_path` | `VARCHAR(255)` | 生成的文件路径 | |
| `start_time` | `DATETIME` | 开始时间 | |
| `end_time` | `DATETIME` | 结束时间 | |

#### 4. 核心模块功能设计

##### 4.1. 任务调度中心 (Task Scheduler)
这是系统的核心，负责整个流程的自动化。

*   **任务创建**: 用户通过CLI输入 `start_crawl --domain "美妆" --pages 50`，调度中心会创建一个 `ingestion` 类型的父任务，并根据需要拆分为多个子任务（例如按页码范围拆分）。
*   **任务分配**:
    *   调度中心查询 **多账号管理器**，获取一个 `idle` 状态的账号。
    *   将一个 `pending` 状态的子任务分配给该账号，并更新任务状态为 `in_progress`，账号状态为 `ingesting` 或 `exporting`。
*   **状态监控**: 调度中心会定期检查 `in_progress` 的任务。如果一个任务长时间没有响应，可以将其标记为 `failed` 并重新分配。
*   **断点续爬逻辑**:
    1.  当一个导出账号达到每日4000的上限时，**导出服务** 会通知调度中心。
    2.  调度中心将当前任务状态更新为 `paused`，并记录当前的 `progress_marker`（例如，最后导出的达人ID）。
    3.  调度中心立即从 **多账号管理器** 获取下一个可用账号。
    4.  创建一个新的导出任务，或更新现有任务，将 `assigned_account_id` 设为新账号，并从 `progress_marker` 记录的位置继续。
    5.  对于入库任务，如果中途中断（如网络问题），重启后，调度中心会根据 `tasks` 表中的 `progress_marker`（如页码）从断开的地方继续爬取。

##### 4.2. 多账号管理器 (Account Manager)
*   **账号池**: 维护一个所有账号的列表及其当前状态和配额。
*   **配额管理**:
    *   提供接口查询账号的剩余导出配额 `get_remaining_quota(account_id)`。
    *   提供接口更新账号的已用配额 `update_export_count(account_id, count)`。
    *   包含一个每日定时任务（如使用cron job），在凌晨自动将所有账号的 `today_export_count` 重置为0。
*   **状态管理**: 提供 `get_idle_account()` 接口，用于获取一个空闲账号。并提供 `set_account_status(account_id, status)` 接口来更新账号状态。

##### 4.3. 入库服务线程 (Ingestion Service Thread)
*   **线程独立性**: 作为一个完全独立的线程进程运行，与导出服务线程完全解耦，实现真正的并行处理。
*   **持续运行特性**: 该线程可以7×24小时不间断运行，不受导出配额限制影响，专注于数据爬取和入库。
*   **任务获取**: 循环向 **任务调度中心** 请求入库任务，支持同时处理多个不同领域的入库任务。
*   **数据处理流程**: 
    *   获取到任务后，使用指定的账号进行爬取
    *   每爬取一个达人，就将其信息存入 `influencers` 表，状态为 `pending_export`
    *   实时更新任务进度，支持断点续爬
*   **日志记录**: 在爬取过程中或结束后，将详细信息（账号、领域、页码、数量、时间）写入 `ingestion_logs` 表
*   **线程安全**: 通过数据库事务和行锁机制，确保多个入库线程实例同时运行时的数据一致性

##### 4.4. 导出服务线程 (Export Service Thread)
*   **线程独立性**: 作为一个完全独立的线程进程运行，与入库服务线程完全解耦，可以独立启动、停止和重启。
*   **配额感知**: 严格遵守账号的每日导出配额限制，智能管理导出节奏。
*   **任务获取**: 循环向 **任务调度中心** 请求导出任务，支持同时处理多个不同领域的导出任务。
*   **数据处理流程**:
    *   获取到任务后，查询 `influencers` 表，找到 `domain` 匹配且 `status` 为 `pending_export` 的达人数据
    *   在导出前，检查分配的账号 `today_export_count` 是否小于 `daily_export_limit`
    *   如果配额充足，则开始导出。每导出一个达人，就更新其状态为 `exported`，并原子地增加账号的 `today_export_count`
*   **智能切换**: 当账号配额用完时，立即停止导出，并通知 **任务调度中心** 切换到下一个可用账号
*   **日志记录**: 导出完成后，将详细信息（账号、领域、导出数量、文件路径）写入 `export_logs` 表
*   **线程安全**: 通过数据库事务确保导出状态更新和配额计数的原子性操作

#### 5. 核心流程详解

##### 5.1. 并行入库与导出流程
**功能实现**: 入库与导出分别运行在独立的线程中，实现真正的并行处理。

1.  **线程启动**: 系统启动时，同时启动 **入库服务线程** 和 **导出服务线程** 两个独立的线程进程。
2.  **用户下发任务**: 用户执行 `start_crawl --domain "游戏"`。
3.  **入库线程处理**:
    *   **任务调度中心** 创建一个 `ingestion` 任务，并分配给一个空闲账号A。
    *   **入库服务线程** 获取该任务，开始使用账号A爬取"游戏"领域的达人，数据源源不断地进入 `influencers` 表。
    *   入库线程可以持续运行，不受任何导出限制影响。
4.  **导出线程并行处理**:
    *   同时，用户可以下发导出指令 `start_export --domain "游戏"`。
    *   **任务调度中心** 创建一个 `export` 任务，并分配给另一个空闲账号B。
    *   **导出服务线程** 获取该任务，开始使用账号B从 `influencers` 表中导出状态为 `pending_export` 的"游戏"达人。
5.  **线程间解耦**: 
    *   入库和导出线程通过数据库进行数据交换，实现完全解耦
    *   两个线程可以使用不同的账号，互不干扰
    *   入库线程不断生产"待导出"数据，导出线程不断消费这些数据
    *   支持多个入库线程和多个导出线程同时运行

##### 5.2. 断点续爬与多账号协作流程
**功能实现**: 解决账号导出限制，实现账号二接着账号一继续爬取。

假设场景：导出"美妆"领域达人，账号1和账号2可用，每日限额4000。

1.  **任务开始**: **任务调度中心** 分配账号1执行"美妆"领域的导出任务。
2.  **执行与监控**: **导出服务** 使用账号1导出数据。每导出一个，`accounts` 表中账号1的 `today_export_count` 加1。
3.  **达到上限**: 当 `today_export_count` 达到4000时，**导出服务** 停止工作，并向 **任务调度中心** 报告：“账号1配额已用尽，最后导出的达人ID是 `XXXXX`”。
4.  **任务暂停与切换**:
    *   **任务调度中心** 将分配给账号1的这个任务状态置为 `paused`，并在 `progress_marker` 字段中记录 `last_id=XXXXX`。
    *   调度中心将账号1的状态置为 `idle`（但其 `today_export_count` 是满的，所以今天不能再用于导出）。
    *   调度中心查询 **多账号管理器**，找到空闲且配额未满的账号2。
5.  **任务接力**:
    *   **任务调度中心** 创建一个新的导出任务（或重用旧任务），分配给账号2。
    *   任务指令中包含断点信息：从 `influencers` 表中 `domain` 为"美妆"且 `id` > `XXXXX` 的地方开始导出。
6.  **继续执行**: **导出服务** 获取新任务，使用账号2无缝地接着账号1的工作继续导出。
7.  **日志记录**:
    *   `export_logs` 会有一条记录，显示账号1导出了4000个"美妆"达人。
    *   当账号2开始导出时，也会有相应的日志记录，从而完整地映射了整个协作流程。


        